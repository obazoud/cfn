{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Creates VPC and related networking componets to support Multi-AZ apps",

  "Parameters" : {
    "Prefix" : {
      "Default" : "CFN.",
      "Description" : "The prefix for the name tags of all the created resources.",
      "Type" : "String",
      "MinLength" : "1",
      "MaxLength" : "64",
      "AllowedPattern" : "[a-zA-Z0-9][a-zA-Z0-9\\.\\-\\_]*",
      "ConstraintDescription" : "must start with an alphanumeric character and contain alphanumeric characters and '.', '-' or '_'."
    },
    "VpcIpPrefix" : {
      "Default": "10.0",
      "Description" : "The first two octets, without the trailing dot, that will be used as the IP Prefix for the subnets created in the VPC.",
      "Type" : "String",
      "MinLength" : "3",
      "MaxLength" : "7",
      "AllowedPattern" : "[0-9]{1,3}\\.[0-9]{1,3}",
      "ConstraintDescription" : "Must be the first two octets of an IP address."
    }
  },

  "Mappings" : {
    "subnetting" : {
        "VPC" :      { "subnet" : "0.0/16" },
        "Public1" :  { "subnet" : "0.0/24" },
        "Public2" :  { "subnet" : "1.0/24" },
        "Private1" : { "subnet" : "100.0/24" },
        "Private2" : { "subnet" : "101.0/24" }
    }
  },

  "Resources" : { 
    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : { "Fn::Join" : [ ".", [ { "Ref" : "VpcIpPrefix" } , { "Fn::FindInMap" : [ "subnetting", "VPC", "subnet" ] } ] ]  },
        "EnableDnsHostnames" : true,
        "Tags" : [ { "Key" : "Name", 
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "VPC" ] ] }
                   } 
                 ]
      }
    },
  
    "SubnetPublic1" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : "" } ] },
        "CidrBlock" : { "Fn::Join" : [ ".", [ { "Ref" : "VpcIpPrefix" } , { "Fn::FindInMap" : [ "subnetting", "Public1", "subnet" ] } ] ]  },
        "MapPublicIpOnLaunch" : true,
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "SubnetPublic1" ] ] }
                   }
                 ]
      }
    },

    "SubnetPublic2" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : { "Fn::Select" : [ "1", { "Fn::GetAZs" : "" } ] },
        "CidrBlock" :  { "Fn::Join" : [ ".", [ { "Ref" : "VpcIpPrefix" } , { "Fn::FindInMap" : [ "subnetting", "Public2", "subnet" ] } ] ]  },
        "MapPublicIpOnLaunch" : true,
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "SubnetPublic2" ] ] }
                   }
                 ]
      }
    },

    "SubnetPrivate1" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : "" } ] },
        "CidrBlock" :  { "Fn::Join" : [ ".", [ { "Ref" : "VpcIpPrefix" } , { "Fn::FindInMap" : [ "subnetting", "Private1", "subnet" ] } ] ]  },
        "MapPublicIpOnLaunch" : false,
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "SubnetPrivate1" ] ] }
                   }
                 ]
      }
    },

    "SubnetPrivate2" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : { "Fn::Select" : [ "1", { "Fn::GetAZs" : "" } ] },
        "CidrBlock" :  { "Fn::Join" : [ ".", [ { "Ref" : "VpcIpPrefix" } , { "Fn::FindInMap" : [ "subnetting", "Private2", "subnet" ] } ] ]  },
        "MapPublicIpOnLaunch" : false,
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "SubnetPrivate2" ] ] }
                   }
                 ]
      }
    },

    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "InternetGateway" ] ] }
                   }
                 ]
      }
    },

    "VPCGatewayAttachmentInternetGateway" : {
      "Type" : "AWS::EC2::VPCGatewayAttachment",
      "Properties" : {
        "InternetGatewayId" : { "Ref" : "InternetGateway" },
        "VpcId" : { "Ref" : "VPC" }
      }
    },

    "RouteTableInternetGateway" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "RouteTableInternetGateway" ] ] }
                   }
                 ]
      }
    },

    "RouteDefaultToInternetGateway" : {
      "Type" : "AWS::EC2::Route",
      "Properties" : {
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "InternetGateway" },
        "RouteTableId" : { "Ref" : "RouteTableInternetGateway" }
      }
    },

    "SubnetRouteTableAssociationRouteTableInternetGatewayToSubnetPublic1" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RouteTableInternetGateway" },
        "SubnetId" : { "Ref" : "SubnetPublic1" }
      }
    },

    "SubnetRouteTableAssociationRouteTableInternetGatewayToSubnetPublic2" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RouteTableInternetGateway" },
        "SubnetId" : { "Ref" : "SubnetPublic2" }
      }
    },

    "StackSecurityGroups" : {
      "Type" : "AWS::CloudFormation::Stack",
      "Properties" : {
        "Parameters" : { "Prefix" : { "Ref" : "Prefix" },
                         "VpcId" : { "Ref" : "VPC" }
                       },
        "TemplateURL" : "https://s3-us-west-2.amazonaws.com/nimbusscale-cfn/security-groups.json",
        "TimeoutInMinutes" : "2"
      }
    },

    "StackNatGw1" : {
      "Type" : "AWS::CloudFormation::Stack",
      "Properties" : {
        "Parameters" : { "Prefix" : { "Ref" : "Prefix" },
                         "VpcId" : { "Ref" : "VPC" },
                         "SubnetIdPublic1" : { "Ref" : "SubnetPublic1" },
                         "SubnetIdPrivate1" : { "Ref" : "SubnetPrivate1" },
                         "SubnetIdPrivate2" : { "Ref" : "SubnetPrivate2" }
                       },
        "TemplateURL" : "https://s3-us-west-2.amazonaws.com/nimbusscale-cfn/nat.json",
        "TimeoutInMinutes" : "2"
      }
    }
  },

  "Outputs" : {
    "Prefix" : {
      "Value" : { "Ref" : "Prefix" },
      "Description" : "Naming Prefix"
    }
  }
}

        
