{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Creates VPC and related networking componets to support Multi-AZ apps",

  "Parameters" : {
    "Prefix" : {
      "Default" : "CFN.",
      "Description" : "The prefix for The names of all created resources",
      "Type" : "String",
      "MinLength" : "1",
      "MaxLength" : "64",
      "AllowedPattern" : "[a-zA-Z0-9][a-zA-Z0-9\\.\\-\\_]*",
      "ConstraintDescription" : "must start with an alphanumeric character and contain alphanumeric characters and '.', '-' or '_'."
    }
  },


  "Resources" : { 
    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : "10.0.0.0/16",
        "EnableDnsHostnames" : true,
        "Tags" : [ { "Key" : "Name", 
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "VPC" ] ] }
                   } 
                 ]
      }
    },
  
    "SubnetPublic1" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : "" } ] },
        "CidrBlock" : "10.0.0.0/24",
        "MapPublicIpOnLaunch" : true,
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "SubnetPublic1" ] ] }
                   }
                 ]
      }
    },

    "SubnetPublic2" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : { "Fn::Select" : [ "1", { "Fn::GetAZs" : "" } ] },
        "CidrBlock" : "10.0.1.0/24",
        "MapPublicIpOnLaunch" : true,
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "SubnetPublic2" ] ] }
                   }
                 ]
      }
    },

    "SubnetPrivate1" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : "" } ] },
        "CidrBlock" : "10.0.100.0/24",
        "MapPublicIpOnLaunch" : false,
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "SubnetPrivate1" ] ] }
                   }
                 ]
      }
    },

    "SubnetPrivate2" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : { "Fn::Select" : [ "1", { "Fn::GetAZs" : "" } ] },
        "CidrBlock" : "10.0.101.0/24",
        "MapPublicIpOnLaunch" : false,
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "SubnetPrivate2" ] ] }
                   }
                 ]
      }
    },

    "IGW" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "IGW" ] ] }
                   }
                 ]
      }
    },

    "AttachIGW2VPC" : {
      "Type" : "AWS::EC2::VPCGatewayAttachment",
      "Properties" : {
        "InternetGatewayId" : { "Ref" : "IGW" },
        "VpcId" : { "Ref" : "VPC" }
      }
    },

    "RoutingTableIGW" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "RoutingTableIGW" ] ] }
                   }
                 ]
      }
    },

    "RouteDefault2IGW" : {
      "Type" : "AWS::EC2::Route",
      "Properties" : {
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "IGW" },
        "RouteTableId" : { "Ref" : "RoutingTableIGW" }
      }
    },

    "AssociateIGWRoutingTable2SubnetPublic1" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RoutingTableIGW" },
        "SubnetId" : { "Ref" : "SubnetPublic1" }
      }
    },

    "AssociateIGWRoutingTable2SubnetPublic2" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RoutingTableIGW" },
        "SubnetId" : { "Ref" : "SubnetPublic2" }
      }
    },

    "SecurityGroups" : {
      "Type" : "AWS::CloudFormation::Stack",
      "Properties" : {
        "Parameters" : { "Prefix" : { "Ref" : "Prefix" },
                         "VpcId" : { "Ref" : "VPC" }
                       },
        "TemplateURL" : "https://s3-us-west-2.amazonaws.com/nimbusscale-cfn/security-groups.json",
        "TimeoutInMinutes" : "2"
      }
    },

    "StackNatGw1" : {
      "Type" : "AWS::CloudFormation::Stack",
      "Properties" : {
        "Parameters" : { "Prefix" : { "Ref" : "Prefix" },
                         "VpcId" : { "Ref" : "VPC" },
                         "SubnetIdPublic1" : { "Ref" : "SubnetPublic1" },
                         "SubnetIdPrivate1" : { "Ref" : "SubnetPrivate1" }, 
                         "SubnetIdPrivate2" : { "Ref" : "SubnetPrivate2" } 
                       },
        "TemplateURL" : "https://s3-us-west-2.amazonaws.com/nimbusscale-cfn/nat.json",
        "TimeoutInMinutes" : "2"
      }
    }
  },

  "Outputs" : {
    "Prefix" : {
      "Value" : { "Ref" : "Prefix" },
      "Description" : "Naming Prefix"
    }
  }
}

        
