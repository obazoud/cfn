{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Creates single or dual NAT instances using ENI and Autoscaling for HA",

  "Parameters" : {
    "Prefix" : {
      "Default" : "CFN.",
      "Description" : "The prefix for The names of all created resources",
      "Type" : "String",
      "MinLength" : "1",
      "MaxLength" : "64",
      "AllowedPattern" : "[a-zA-Z0-9][a-zA-Z0-9\\.\\-\\_]*",
      "ConstraintDescription" : "must start with an alphanumeric character and contain alphanumeric characters and '.', '-' or '_'."
    },

   "VpcId" : {
      "Description" : "The VPC which the security groups will belong",
      "Type" : "AWS::EC2::VPC::Id"
    },

    "SubnetIdPublic1" : {
      "Description" : "The SubnetId for the NatGw1",
      "Type" : "AWS::EC2::Subnet::Id"
    },

    "SubnetIdPrivate1" : {
      "Description" : "The SubnetId for the first private subnet",
      "Type" : "AWS::EC2::Subnet::Id"
    },
    
    "SubnetIdPrivate2" : {
      "Description" : "The SubnetId for the second private subnet",
      "Type" : "AWS::EC2::Subnet::Id"
    }
  },

  "Resources" : {
    "EipNatGw1" : {
      "Type" : "AWS::EC2::EIP",
      "Properties" : {
        "Domain" : "vpc"
      }
    },
    
    "NetworkInterfaceNatGw1" : {
      "Type" : "AWS::EC2::NetworkInterface",
      "Properties" : {
        "Description" : "Attached to NAT GW Instance to provide consistant instance for routing",
        "SourceDestCheck" : false,
        "SubnetId" : { "Ref" : "SubnetIdPublic1" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "NetworkInterfaceNatGw1" ] ] }
                     }
                 ]
        }
    },

    "EIPAssociationEipNatGw1toNetworkInterfaceNatGw1" : {
      "Type" : "AWS::EC2::EIPAssociation",
      "Properties" : {
        "AllocationId" : { "Fn::GetAtt" : [ "EipNatGw1", "AllocationId" ] },
        "NetworkInterfaceId" : { "Ref" : "NetworkInterfaceNatGw1" }
      }
    },

    "RouteTableNatGw1" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "VpcId" },
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "RouteTableNatGw1" ] ] }
                     }
                 ]
        }
      },

    "RouteNatGw1" : { 
      "Type" : "AWS::EC2::Route",
      "Properties" : { 
        "DestinationCidrBlock" : "0.0.0.0/0",
        "NetworkInterfaceId" : { "Ref" : "NetworkInterfaceNatGw1" },
        "RouteTableId" : { "Ref" : "RouteTableNatGw1" }
      }
    },

    "SubnetRouteTableAssociationRouteTableNatGw1toSubnetPrivate1" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RouteTableNatGw1" },
        "SubnetId" : { "Ref" : "SubnetIdPrivate1" }
      }
    },

    "SubnetRouteTableAssociationRouteTableNatGw1toSubnetPrivate2" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RouteTableNatGw1" },
        "SubnetId" : { "Ref" : "SubnetIdPrivate2" }
      }
    },

    "RoleNatGw" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : { 
        "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [ {
                "Action": "sts:AssumeRole",
                "Principal": { "Service": "ec2.amazonaws.com" },
                "Effect": "Allow",
                "Sid": ""
              } ]
        },
        "Policies": [ {
          "PolicyName" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "AttachNetworkInterface" ] ] },
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [ {
              "Effect": "Allow",
              "Action": "ec2:AttachNetworkInterface",
              "Resource": "*"
            } ] 
          }
        } ]
      }
    },

    "InstanceProfileNatGw" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [ { "Ref" : "RoleNatGw" } ]
      }
    },

    "InstanceNatGw1" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata" : {
        "AWS::CloudFormation::Init" : {
          "config" : {
            "files" : {
              "/var/tmp/NetworkInterfaceId" : {
                "content" : { "Ref" : "NetworkInterfaceNatGw1" },
                "mode" : "000400",
                "owner" : "root",
                "group" : "root"
              },
              "/usr/local/bin/attach_eth1_eni.sh" : {
                "content" : { "Fn::Join" : [ "", [
                    "#!/bin/bash\n",
                    "function log () {\n",
                    "  echo \"$(date +\"%b %e %T\") $@\"\n",
                    "  logger -- $(basename $0)\" - $@\"\n",
                    "}\n",
                    "InstanceId=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
                    "NetworkInterfaceId=$(cat /var/tmp/NetworkInterfaceId)\n",
                    "export AWS_DEFAULT_REGION=\"", { "Ref" : "AWS::Region" }, "\"\n",
                    "/usr/bin/aws ec2 attach-network-interface --network-interface-id ${NetworkInterfaceId} --instance-id ${InstanceId} --device-index 1\n",
                    "retcode=$?\n",
                    "[ \"$retcode\" -eq 0 ] && { log \"eni attachment successful\" ; exit 0 ; } || { log \"eni attachment failed\" ; exit 1 ; }\n"
                  ] ] },
                "mode" : "000500",
                "owner" : "root",
                "group" : "root"
              }
            }
          }
        }
      },
      "Properties" : {
        "IamInstanceProfile" : { "Ref" : "InstanceProfileNatGw" },
        "ImageId" : "ami-69ae8259",
        "InstanceType" : "t2.micro",
        "KeyName" : "jjk3@nimbusscale",
        "NetworkInterfaces" : [ { "AssociatePublicIpAddress" : false,
                                  "DeviceIndex" : "0",
                                  "SubnetId" : { "Ref" : "SubnetIdPublic1" }
                              } ],
        "Tags" : [ { "Key" : "Name",
                     "Value" : { "Fn::Join" : [ "", [ { "Ref" : "Prefix" }, "InstanceNatGw1" ] ] }
                   }
                 ],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
                        "#!/bin/bash\n",
                        "yum update -y aws-cfn-bootstrap\n",
                        "# Install the files and packages from the metadata\n",
                        "/opt/aws/bin/cfn-init -v ",
                        "         --stack ", { "Ref" : "AWS::StackName" },
                        "         --resource InstanceNatGw1 ",
                        "         --region ", { "Ref" : "AWS::Region" }, "\n",
                        "/usr/local/bin/attach_eth1_eni.sh\n"
                      ]]}}  
        },
        "DependsOn" : "NetworkInterfaceNatGw1"
      }

  }
}

